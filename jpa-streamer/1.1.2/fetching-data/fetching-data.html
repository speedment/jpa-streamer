<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fetching Data :: JPAStreamer</title>
    <link rel="prev" href="../stream-fundamentals/other_operations.html">
    <link rel="next" href="sql-equivalents.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item logo" href="https://chronicle.software"></a>
        <div class="navbar-item" style="background: none">
          <input id="search-input" type="text" placeholder="Search docs...">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
          <a class="navbar-item" href="https://speedment.github.io/jpa-streamer/">Home</a>
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Resources</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" href="https://gitter.im/speedment/jpa-streamer">Gitter Chat</a>
                  <a class="navbar-item" href="https://jpastreamer.org">Website</a>
                  <a class="navbar-item" href="https://github.com/speedment/jpa-streamer">GitHub</a>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jpa-streamer" data-version="1.1.2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction/introduction.html">Introduction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../why-jpastreamer/why-jpastreamer.html">Why JPAstreamer?</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../how-it-works/how-it-works.html">How JPAstreamer Works</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quick-start/quick-start.html">Quick-start with JPAstreamer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <span class="nav-text">Get JPAstreamer</span>
    <button class="nav-item-toggle"></button>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-jpa-streamer/install-maven.html">Install with Maven</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-jpa-streamer/install-gradle.html">Install with Gradle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-jpa-streamer/spring_integration.html">Spring Integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../get-jpa-streamer/cdi_integration.html">CDI Integration</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../predicates/predicates.html">Predicates</a>
    <button class="nav-item-toggle"></button>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../predicates/reference-predicates.html">Reference Predicates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../predicates/comparable-predicates.html">Comparable Predicates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../predicates/string-predicates.html">String Predicates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../predicates/primitive-predicates.html">Primitive Predicates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../predicates/negating-predicates.html">Negating Predicates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../predicates/combining-predicates.html">Combining Predicates</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../stream-fundamentals/stream_basics.html">Stream Fundamentals</a>
    <button class="nav-item-toggle"></button>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stream-fundamentals/intermediate_operations.html">Intermediate Operations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stream-fundamentals/terminal_operations.html">Terminal Operations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stream-fundamentals/other_operations.html">Other Operations</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="fetching-data.html">Fetching Data</a>
    <button class="nav-item-toggle"></button>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sql-equivalents.html">SQL Equivalents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stream-examples.html">Stream Examples</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../transactions/transactions.html">Transactions</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">JPAStreamer Docs</span>
    <span class="version">1.1.2</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">JPAStreamer Docs</span>
      <ul class="versions">
        <li class="version">
          <a href="../../1.1.4/introduction/introduction.html">1.1.4</a>
        </li>
        <li class="version">
          <a href="../../1.1.3/introduction/introduction.html">1.1.3</a>
        </li>
        <li class="version is-current">
          <a href="../introduction/introduction.html">1.1.2</a>
        </li>
        <li class="version">
          <a href="../../1.1.0/introduction/introduction.html">1.1.0</a>
        </li>
        <li class="version">
          <a href="../../1.0.2/introduction/introduction.html">1.0.2</a>
        </li>
        <li class="version">
          <a href="../../1.0.1/introduction/introduction.html">1.0.1</a>
        </li>
        <li class="version">
          <a href="../../1.0.0/introduction/introduction.html">1.0.0</a>
        </li>
        <li class="version">
          <a href="../../0.1.8/introduction/introduction.html">0.1.8</a>
        </li>
        <li class="version">
          <a href="../../0.1.7/introduction/introduction.html">0.1.7</a>
        </li>
        <li class="version">
          <a href="../../0.1.6/introduction/introduction.html">0.1.6</a>
        </li>
        <li class="version">
          <a href="../../0.1.5/introduction/introduction.html">0.1.5</a>
        </li>
        <li class="version">
          <a href="../../0.1.4/introduction/introduction.html">0.1.4</a>
        </li>
        <li class="version">
          <a href="../../0.1.3/introduction/introduction.html">0.1.3</a>
        </li>
        <li class="version">
          <a href="../../0.1.2/introduction/introduction.html">0.1.2</a>
        </li>
        <li class="version">
          <a href="../../0.1.0/introduction/introduction.html">0.1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
</div>
  <div class="content">
<article class="doc">
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../introduction/introduction.html">JPAStreamer Docs</a></li>
    <li><a href="fetching-data.html">Fetching Data</a></li>
  </ul>
</nav>
<h1 class="page">Fetching Data</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>To start fetching data with JPAsStreamer you need to initialize an instance of <code>JPAStreamer</code>. This section describes how that is accomplished.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_obtaining_a_jpastreamer_instance"><a class="anchor" href="#_obtaining_a_jpastreamer_instance"></a>Obtaining a JPAStreamer instance</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_from_persistence_unit_name"><a class="anchor" href="#_from_persistence_unit_name"></a>From persistence unit name</h3>
<div class="paragraph">
<p>The simplest way to initialize JPAstreamer is by providing the name of the persistence unit like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">JPAStreamer jpaStreamer = JPAStreamer.of("sakila"); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>"sakila" is to be replaced with the name of <strong>your</strong> persistence unit that can be found in a configuration-file</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the example, the String "sakila" should refer to the name of your persistence unit. Assuming you are already using a JPA provider, your project should contain an XML-file like the one below, describing the persistence unit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence version="2.2"
             xmlns="http://xmlns.jcp.org/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence
     http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd"&gt;

    &lt;persistence-unit name="sakila" transaction-type="RESOURCE_LOCAL"&gt; <i class="conum" data-value="1"></i><b>(1)</b>
        &lt;description&gt;MySQL Sakila Example Database&lt;/description&gt;
        &lt;provider&gt;org.hibernate.jpa.HibernatePersistenceProvider&lt;/provider&gt;
        &lt;properties&gt;
            &lt;!-- Configuring The Database Connection Details --&gt;
            &lt;property name="javax.persistence.jdbc.driver" value="com.mysql.cj.jdbc.Driver" /&gt;
            &lt;property name="javax.persistence.jdbc.url" value="jdbc:mysql://localhost:3306/sakila" /&gt;

            &lt;!-- ... --&gt;

        &lt;/properties&gt;
    &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of the persistence unit, in this case "sakila", is used to initialize JPAStreamer.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This configuration is just an example configuration for the <a href="https://dev.mysql.com/doc/sakila/en/">MySQL Sakila example database</a>. You should use the configuration you already have in place.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you have multiple persistence units, you can initiate several instances of <code>JPAStreamer</code> to establish connections with different sources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>JPAStreamer does not need any additional configuration and depends solely on this file to establish a database connection. If your starting a project from scratch, make sure to set up your JPA project before trying to use JPAStreamer.</p>
</div>
<div class="paragraph">
<p>Having obtained a <code>JPAStreamer</code> instance, you are ready to go. Here is an example that includes both the instantiation and the querying:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static void main(String[] args) {

    JPAStreamer jpaStreamer = JPAStreamer.createJPAStreamerBuilder("sakila") <i class="conum" data-value="1"></i><b>(1)</b>
        .build();

    long count = jpaStreamer.stream(Film.class)
        .filter(Film$.title.startsWith("A"))
        .count();

    System.out.format("There are %d films with a title that starts with A", count);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_from_entitymanagagerfactory"><a class="anchor" href="#_from_entitymanagagerfactory"></a>From <code>EntityManagagerFactory</code></h3>
<div class="paragraph">
<p>When configuring JPAStreamer with the persistence unit name as described above, a new <code>EntityManagerFactory</code> is created and managed by JPAStreamer. In this case, JPAStreamer is responsible for the life cycle of the factory, and calling <code>JPAStreamer::close</code> will close the <code>EntityManagerFactory</code>.</p>
</div>
<div class="paragraph">
<p>If you rather wish to reuse an existing <code>EntityManagerFactory</code> you can initialize JPAStreamer as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">EntityManagerFactory emf = Persistence.createEntityManagerFactory("sakila");
JPAStreamer jpaStreamer = JPAStreamer.of(emf);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this case, JPAStreamer is not responsible for clearing up the factory resources and calling <code>JPAStreamer::close</code> will not close the <code>EntityManagerFactory</code>. However, <code>EntityManager</code> instances obtained via the factory are still managed by JPAStreamer.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_supplier"><a class="anchor" href="#_supplier"></a>From <code>Supplier&lt;EntityManager&gt;</code></h3>
<div class="paragraph">
<p>As a third option, JPAStreamer can be handed a <code>Supplier</code> of Entity Managers. In this case, JPAStreamer is not responsible for the lifecycle of any supplied Entity Managers. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">EntityManagerFactory emf = Persistence.createEntityManagerFactory("sakila");
JPAStreamer jpaStreamer = JPAStreamer.of(emf::createEntityManager);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is especially useful in contexts where JPAStreamer may not be permitted to create and manage its own <code>EntityManagerFactory</code>, and/or no reference to an <code>EntityManagerFactory</code> is present. An example of such an environment is inside a <code>PanacheRepository</code> when running Hibernate and Panache. <code>PanacheRepository</code> inherits <code>getEntityManager()</code> from <code>PanacheEntityBase</code>, which can be used to supply JPAStreamer with Entity Managers as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class FilmRepository implements PanacheRepository&lt;Film&gt; {

    private final JPAStreamer jpaStreamer = JPAStreamer.of(this::getEntityManager);

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using a Supplier, JPAStreamer is not responsible for the lifecycle of the Entity Managers, thus <code>JPAStreamer::close</code> will not close any supplied Entity Managers.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resetting_the_streamer"><a class="anchor" href="#_resetting_the_streamer"></a>Resetting the Streamer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Calling <code>jpaStreamer.stream(Class&lt;T&gt; entityClass)</code> creates a dedicated Streamer for the provided Entity class. The Streamer instance is reused for subsequent calls on <code>jpaStreamer.stream()</code> on the same Entity, see example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">JPAStreamer jpaStreamer = JPAStreamer.createJPAStreamerBuilder("sakila")
        .build();

long count = jpaStreamer.stream(Film.class) <i class="conum" data-value="1"></i><b>(1)</b>
        .filter(Film$.title.startsWith("A"))
        .count();

long count2 = jpaStreamer.stream(Film.class) <i class="conum" data-value="2"></i><b>(2)</b>
        .filter(Film$.title.startsWith("A"))
        .count();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first call to <code>jpaStreamer.stream(Film.class)</code> will create a <code>Streamer</code> of <code>Film</code> entities</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The second call will reuse the previously configured <code>Streamer</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>Streamer</code> instance hold a <code>javax.persistence.EntityManager</code> which has its own first-layer cache. Thus by default, database changes performed by another application, or made directly on the database, will not be detected. In the example above, the addition of the film "Avatar" to the database between the first and second count query therefore goes unnoticed and <code>count</code> will equal <code>count2</code>.</p>
</div>
<div class="paragraph">
<p>To ensure that database updates performed by another application are detected, you must reset the Streamer between queries. This will effectively remove the existing Streamer for the specified Entity and close its associated <code>EntityManager</code>. The next query will create a new Streamer with a new <code>EntityManager</code>, resetting the first-level cache associated with the Entity.</p>
</div>
<div class="paragraph">
<p>You can reset the Streamer for one or more Entity classes with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">jpaStreamer.resetStreamer(Class&lt;?&gt;... entityClasses);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
JPAStreamer instances configured with a <code>Supplier&lt;EntityManager</code> do not manage the lifecycle of the supplied Entity Managers, and thus cannot close them. Calling <code>resetStreamer</code> on such instance result in an <code>UnsupportedOperationException</code>. See, <a href="#_supplier">Initializing JPAStreamer with a Supplier</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can thus update the prior example to ensure that database changes are detected as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">JPAStreamer jpaStreamer = JPAStreamer.createJPAStreamerBuilder("sakila")
        .build();

long count = jpaStreamer.stream(Film.class) <i class="conum" data-value="1"></i><b>(1)</b>
        .filter(Film$.title.startsWith("A"))
        .count();

jpaStreamer.resetStreamer(Film.class); <i class="conum" data-value="2"></i><b>(2)</b>

long count2 = jpaStreamer.stream(Film.class) <i class="conum" data-value="3"></i><b>(3)</b>
        .filter(Film$.title.startsWith("A"))
        .count();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a Streamer of <code>Film</code> entities</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resets (removes) the Streamer of <code>Film</code> entities. This resets the first-level cache.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates a new Streamer of <code>Film</code> entities</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_whats_next"><a class="anchor" href="#_whats_next"></a>What&#8217;s Next</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="sql-equivalents.html" class="xref page">next section</a> demonstrates how to use the available Stream operators and how they map to SQL constructs.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../stream-fundamentals/other_operations.html">Other Operations</a></span>
  <span class="next"><a href="sql-equivalents.html">SQL Equivalents</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>Â© 2020 Speedment, Inc. All rights reserved.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/search.js" id="search-script" data-base-path="../../.." data-page-path="/jpa-streamer/1.1.2/fetching-data/fetching-data.html"></script>
<script async src="../../../_/../search-index.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
